---
/**
 * IntroAnimation.astro
 * 
 * Section 1: "It all starts with the Terminal"
 * 
 * Animation stages:
 * - terminal-appear: Terminal window fades in, types ./GETTING_STARTED, shows welcome + history
 * - script-demo: Shows example terminal commands (open app, rename file, run script)
 * - plug-animation: ASCII plug connects to socket with spark effect
 * - capabilities: Shows "Terminals can be used for a lot..." messages
 */

interface Props {
  class?: string;
}

const { class: className = '' } = Astro.props;
---

<div class:list={['intro-animation', className]} data-intro-animation>
  <div class="terminal-window">
    <div class="terminal-chrome">
      <div class="window-controls">
        <span class="dot red"></span>
        <span class="dot yellow"></span>
        <span class="dot green"></span>
      </div>
      <span class="terminal-title">Terminal</span>
    </div>
    
    <div class="terminal-content">
      <!-- Command line -->
      <div class="terminal-line" data-line="1">
        <span class="prompt">$</span>
        <span class="typed-text" data-typed="command"></span>
        <span class="cursor">█</span>
      </div>
      
      <!-- Welcome -->
      <div class="terminal-output" data-line="2">
        <div class="output-text" data-text="welcome">Welcome to the Terminal.</div>
      </div>
      
      <!-- History line 1 -->
      <div class="terminal-output" data-line="3">
        <div class="output-text" data-text="history1">Terminals have been around a very long time.</div>
      </div>
      
      <!-- History line 2 -->
      <div class="terminal-output" data-line="4">
        <div class="output-text" data-text="history2">They allow you to plug in to how the computer actually runs.</div>
      </div>
      
      <!-- ASCII Plug Animation -->
      <div class="plug-container" data-line="5">
        <pre class="ascii-art plug-left" data-plug="left">      ┌──────┐
══════╡ ●  ● │
══════╡ ●  ● │
      └──────┘</pre>
        <div class="spark-container">
          <span class="spark" data-plug="spark">⚡</span>
        </div>
        <pre class="ascii-art plug-right" data-plug="right">┌──────┐
│ ○  ○ ╞══════
│ ○  ○ ╞══════
└──────┘</pre>
      </div>
      
      <!-- Connected state -->
      <div class="connected-container" data-line="6">
        <pre class="ascii-art connected" data-connected>      ┌──────┬──────┐
══════╡ ●  ● │ ○  ○ ╞════════════╗
══════╡ ●  ● │ ○  ○ ╞════════════╬══▶ <span class="connected-text">CONNECTED</span>
      └──────┴──────┘            ╚═══</pre>
      </div>
      
      <!-- Capabilities -->
      <div class="terminal-output" data-line="7">
        <div class="output-text" data-text="cap1">Terminals can be used for a lot,</div>
        <div class="output-text" data-text="cap2">including running and writing code.</div>
      </div>
      
      <!-- Script Demo - shows terminal running scripts -->
      <div class="script-demo" data-line="8">
        <div class="script-intro" data-text="script-intro">Terminals love scripts:</div>
        
        <div class="demo-command" data-demo="1">
          <div class="demo-line">
            <span class="prompt">$</span>
            <span class="demo-typed" data-demo-typed="1"></span>
          </div>
          <div class="demo-output" data-demo-output="1">✓ Firefox opened</div>
        </div>
        
        <div class="demo-command" data-demo="2">
          <div class="demo-line">
            <span class="prompt">$</span>
            <span class="demo-typed" data-demo-typed="2"></span>
          </div>
          <div class="demo-output" data-demo-output="2">report_draft.docx → report_final.docx</div>
        </div>
        
        <div class="demo-command" data-demo="3">
          <div class="demo-line">
            <span class="prompt">$</span>
            <span class="demo-typed" data-demo-typed="3"></span>
          </div>
          <div class="demo-output multi-line" data-demo-output="3">Found 47 files
Renamed 47 files
Done in 0.3s</div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .intro-animation {
    height: 100%;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .terminal-window {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    background: #0a0a0a;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    opacity: 0;
    transform: translateY(10px);
    font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
  }

  .terminal-chrome {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    background: #1a1a1a;
    border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    flex-shrink: 0;
  }

  .window-controls {
    display: flex;
    gap: 8px;
  }

  .dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
  }

  .dot.red { background: #ff5f56; }
  .dot.yellow { background: #ffbd2e; }
  .dot.green { background: #27ca40; }

  .terminal-title {
    color: rgba(255, 255, 255, 0.5);
    font-size: 0.8rem;
  }

  .terminal-content {
    padding: 1.5rem 2rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    overflow-y: auto;
    font-size: 1rem;
    line-height: 1.6;
    flex: 1;
  }

  .terminal-line {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    opacity: 0;
  }

  .prompt {
    color: #22c55e;
    font-weight: 600;
  }

  .typed-text {
    color: #e2e8f0;
  }

  .cursor {
    color: #22c55e;
    visibility: hidden;
  }

  .cursor.active {
    visibility: visible;
    animation: blink 1s step-end infinite;
  }

  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0; }
  }

  .terminal-output {
    padding-left: 1rem;
    opacity: 0;
  }

  .output-text {
    opacity: 0;
  }

  .output-text[data-text="welcome"] {
    color: #a78bfa;
    font-size: 1.3rem;
    font-weight: 600;
  }

  .output-text[data-text="history1"],
  .output-text[data-text="history2"] {
    color: rgba(255, 255, 255, 0.8);
  }

  .output-text[data-text="cap1"],
  .output-text[data-text="cap2"] {
    color: rgba(255, 255, 255, 0.85);
  }

  /* Script Demo Styles */
  .script-demo {
    opacity: 0;
    padding-top: 1rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    margin-top: 0.5rem;
  }

  .script-intro {
    color: #fbbf24;
    font-weight: 600;
    margin-bottom: 1rem;
    opacity: 0;
  }

  .demo-command {
    margin-bottom: 0.75rem;
    opacity: 0;
  }

  .demo-line {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .demo-typed {
    color: #e2e8f0;
  }

  .demo-output {
    color: #4ade80;
    padding-left: 1.25rem;
    margin-top: 0.25rem;
    opacity: 0;
    font-size: 0.9rem;
  }

  .demo-output.multi-line {
    white-space: pre-line;
    line-height: 1.4;
  }

  /* Plug Animation */
  .plug-container {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1.5rem 0;
    opacity: 0;
    min-height: 100px;
  }

  .ascii-art {
    margin: 0;
    font-size: 1rem;
    line-height: 1.2;
    opacity: 0;
    white-space: pre;
    font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
  }

  .plug-left {
    color: #a78bfa;
  }

  .plug-right {
    color: #60a5fa;
  }

  .spark-container {
    width: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }

  .spark {
    color: #fbbf24;
    font-size: 2.5rem;
    opacity: 0;
    position: absolute;
    text-shadow: 0 0 30px rgba(251, 191, 36, 0.9);
  }

  .connected-container {
    display: none;
    align-items: center;
    justify-content: center;
    padding: 1.5rem 0;
    opacity: 0;
  }

  .connected {
    color: #22c55e;
    font-size: 1rem;
    line-height: 1.2;
    white-space: pre;
    opacity: 0;
  }

  .connected-text {
    color: #4ade80;
    font-weight: bold;
    text-shadow: 0 0 15px rgba(74, 222, 128, 0.6);
  }
</style>

<script>
  import gsap from 'gsap';

  /**
   * IntroAnimationController
   * 
   * Supports stage-based animation for timeline integration.
   * 
   * Stages:
   * - terminal-appear: Terminal window fades in, types ./GETTING_STARTED, shows welcome + history
   * - plug-animation: ASCII plug connects to socket with spark effect
   * - capabilities: Shows "Terminals can be used for a lot..." messages
   * - script-demo: Shows example terminal commands
   */
  class IntroAnimationController {
    private container: HTMLElement;
    private currentTimeline: gsap.core.Timeline | null = null;
    private isPlaying = false;

    constructor(container: HTMLElement) {
      this.container = container;
      this.init();
    }

    private q(sel: string): HTMLElement {
      return this.container.querySelector(sel) as HTMLElement;
    }

    private qAll(sel: string): NodeListOf<Element> {
      return this.container.querySelectorAll(sel);
    }

    private typeText(element: HTMLElement, text: string, duration: number): gsap.core.Tween {
      const chars = text.split('');
      element.textContent = '';
      return gsap.to({ i: 0 }, {
        i: chars.length,
        duration,
        ease: 'none',
        onUpdate: function() {
          element.textContent = chars.slice(0, Math.floor(this.targets()[0].i)).join('');
        }
      });
    }

    private init() {
      // Listen for stage-based animation triggers (timeline integration)
      document.addEventListener('animation:play-stage', (e: Event) => {
        const detail = (e as CustomEvent).detail;
        if (detail.sectionId === 'intro') {
          this.playStage(detail.stage);
        }
      });

      // Legacy: full animation trigger
      document.addEventListener('animation:start', (e: Event) => {
        const detail = (e as CustomEvent).detail;
        if (detail.sectionId === 'intro') {
          this.playAll();
        }
      });

      // Reset when section changes away
      document.addEventListener('section:change', (e: Event) => {
        const detail = (e as CustomEvent).detail;
        if (detail.sectionData?.id !== 'intro') {
          this.reset();
        }
      });

      // Reset on replay request
      document.addEventListener('animation:reset', (e: Event) => {
        const detail = (e as CustomEvent).detail;
        if (detail.sectionId === 'intro') {
          this.reset();
        }
      });
    }

    /**
     * Play a specific animation stage
     */
    playStage(stage: string) {
      if (this.isPlaying) return;
      
      if (this.currentTimeline) {
        this.currentTimeline.kill();
        this.currentTimeline = null;
      }

      this.isPlaying = true;

      const tl = gsap.timeline({
        onComplete: () => {
          this.isPlaying = false;
          document.dispatchEvent(new CustomEvent('animation:stage-complete', {
            detail: { sectionId: 'intro', stage }
          }));
        }
      });

      this.currentTimeline = tl;

      switch (stage) {
        case 'terminal-appear':
          this.buildTerminalAppearStage(tl);
          break;
        case 'plug-animation':
          this.buildPlugAnimationStage(tl);
          break;
        case 'capabilities':
          this.buildCapabilitiesStage(tl);
          break;
        case 'script-demo':
          this.buildScriptDemoStage(tl);
          break;
        default:
          console.warn(`Unknown animation stage: ${stage}`);
          this.isPlaying = false;
      }
    }

    /**
     * Stage 1: Terminal appears, types ./GETTING_STARTED, shows welcome + history
     */
    private buildTerminalAppearStage(tl: gsap.core.Timeline) {
      const cursor = this.q('[data-line="1"] .cursor');

      // Terminal window fades in
      tl.to(this.q('.terminal-window'), {
        opacity: 1,
        y: 0,
        duration: 0.6,
        ease: 'power2.out'
      });

      // Show first line and cursor
      tl.to(this.q('[data-line="1"]'), { opacity: 1, duration: 0.1 });
      tl.call(() => cursor?.classList.add('active'));
      
      // Pause with blinking cursor
      tl.to({}, { duration: 1.0 });

      // Type "./GETTING_STARTED"
      tl.add(this.typeText(this.q('[data-typed="command"]'), './GETTING_STARTED', 1.2));
      tl.call(() => cursor?.classList.remove('active'));
      
      // Pause before welcome
      tl.to({}, { duration: 0.8 });
      
      // Show welcome
      tl.to(this.q('[data-line="2"]'), { opacity: 1, duration: 0.1 });
      tl.to(this.q('[data-text="welcome"]'), { 
        opacity: 1, 
        duration: 0.6,
        ease: 'power2.out'
      });
      
      // Hold on welcome
      tl.to({}, { duration: 2.5 });
      
      // Show first history line
      tl.to(this.q('[data-line="3"]'), { opacity: 1, duration: 0.1 });
      tl.to(this.q('[data-text="history1"]'), { opacity: 1, duration: 0.5 });
      
      // Hold
      tl.to({}, { duration: 2.0 });
      
      // Show second history line
      tl.to(this.q('[data-line="4"]'), { opacity: 1, duration: 0.1 });
      tl.to(this.q('[data-text="history2"]'), { opacity: 1, duration: 0.5 });
      
      // Hold
      tl.to({}, { duration: 2.0 });
    }

    /**
     * Stage 2: ASCII plug animation - plug connects to socket
     */
    private buildPlugAnimationStage(tl: gsap.core.Timeline) {
      const plugContainer = this.q('[data-line="5"]');
      const plugLeft = this.q('[data-plug="left"]');
      const plugRight = this.q('[data-plug="right"]');
      const spark = this.q('[data-plug="spark"]');
      const connectedContainer = this.q('[data-line="6"]');
      const connected = this.q('[data-connected]');

      // Show plug container
      tl.to(plugContainer, { opacity: 1, duration: 0.3 });
      
      // Show plugs separated
      tl.to(plugLeft, { opacity: 1, x: -80, duration: 0.4 });
      tl.to(plugRight, { opacity: 1, x: 80, duration: 0.4 }, '<');

      // Hold - see separated state
      tl.to({}, { duration: 1.2 });

      // Move plugs together
      tl.to(plugLeft, { x: -5, duration: 0.8, ease: 'power2.inOut' });
      tl.to(plugRight, { x: 5, duration: 0.8, ease: 'power2.inOut' }, '<');

      // Spark burst!
      tl.to(spark, { opacity: 1, scale: 1.5, duration: 0.1, ease: 'power4.out' });
      tl.to(spark, { scale: 2, duration: 0.1 });
      tl.to(spark, { opacity: 0, scale: 0.5, duration: 0.25 });

      // Hide plug animation, show connected
      tl.to(plugContainer, { opacity: 0, duration: 0.3 });
      tl.set(plugContainer, { display: 'none' });
      tl.set(connectedContainer, { display: 'flex', opacity: 0 });
      tl.to(connectedContainer, { opacity: 1, duration: 0.4 });
      tl.to(connected, { opacity: 1, duration: 0.5, ease: 'power2.out' });

      // Flash the connected text green
      tl.to(connected, { textShadow: '0 0 30px rgba(74, 222, 128, 0.9)', duration: 0.2 });
      tl.to(connected, { textShadow: '0 0 10px rgba(74, 222, 128, 0.3)', duration: 0.6 });
      
      // Hold on connected state
      tl.to({}, { duration: 2.0 });
    }

    /**
     * Stage 3: Capabilities message
     */
    private buildCapabilitiesStage(tl: gsap.core.Timeline) {
      // Show capabilities text - first line
      tl.to(this.q('[data-line="7"]'), { opacity: 1, duration: 0.1 });
      tl.to(this.q('[data-text="cap1"]'), { opacity: 1, duration: 0.5 });
      
      // Hold
      tl.to({}, { duration: 1.5 });
      
      // Second line
      tl.to(this.q('[data-text="cap2"]'), { opacity: 1, duration: 0.5 });
      
      // Hold
      tl.to({}, { duration: 2.0 });
    }

    /**
     * Stage 4: Script demo - shows terminal running example scripts
     * Triggered after "Terminals love scripts" content
     */
    private buildScriptDemoStage(tl: gsap.core.Timeline) {
      const commands = [
        { typed: 1, text: 'open Firefox.app', delay: 0.6 },
        { typed: 2, text: 'mv report_draft.docx report_final.docx', delay: 0.9 },
        { typed: 3, text: './rename-screenshots.sh', delay: 0.7 }
      ];

      // Show script demo container
      tl.to(this.q('[data-line="8"]'), { opacity: 1, duration: 0.3 });
      
      // Show intro text
      tl.to(this.q('[data-text="script-intro"]'), { opacity: 1, duration: 0.4 });
      tl.to({}, { duration: 0.8 });

      // Run through each command
      commands.forEach((cmd, i) => {
        const demoEl = this.q(`[data-demo="${cmd.typed}"]`);
        const typedEl = this.q(`[data-demo-typed="${cmd.typed}"]`);
        const outputEl = this.q(`[data-demo-output="${cmd.typed}"]`);

        // Show command container
        tl.to(demoEl, { opacity: 1, duration: 0.2 });
        
        // Type the command
        tl.add(this.typeText(typedEl, cmd.text, cmd.delay));
        
        // Brief pause then show output
        tl.to({}, { duration: 0.3 });
        tl.to(outputEl, { opacity: 1, duration: 0.3 });
        
        // Hold before next command (longer on last one)
        tl.to({}, { duration: i === commands.length - 1 ? 1.5 : 0.8 });
      });
    }

    /**
     * Play all stages sequentially (legacy support)
     */
    playAll() {
      if (this.isPlaying) return;

      if (this.currentTimeline) {
        this.currentTimeline.kill();
        this.currentTimeline = null;
      }

      this.resetElements();
      this.isPlaying = true;

      const tl = gsap.timeline({
        onComplete: () => { 
          this.isPlaying = false;
          document.dispatchEvent(new CustomEvent('animation:stage-complete', {
            detail: { sectionId: 'intro', stage: 'all' }
          }));
        }
      });

      this.currentTimeline = tl;

      // Build all stages with pauses between
      this.buildTerminalAppearStage(tl);
      tl.to({}, { duration: 1.5 });
      this.buildPlugAnimationStage(tl);
      tl.to({}, { duration: 1.5 });
      this.buildCapabilitiesStage(tl);
      tl.to({}, { duration: 1.5 });
      this.buildScriptDemoStage(tl);
    }

    private resetElements() {
      gsap.set(this.q('.terminal-window'), { opacity: 0, y: 10 });
      gsap.set(this.qAll('.terminal-line'), { opacity: 0 });
      gsap.set(this.qAll('.terminal-output'), { opacity: 0 });
      gsap.set(this.qAll('.output-text'), { opacity: 0 });
      gsap.set(this.q('[data-line="5"]'), { opacity: 0, display: 'flex' });
      gsap.set(this.q('[data-line="6"]'), { opacity: 0, display: 'none' });
      gsap.set(this.qAll('.ascii-art'), { opacity: 0, x: 0 });
      gsap.set(this.q('[data-plug="spark"]'), { opacity: 0, scale: 0 });
      gsap.set(this.q('[data-connected]'), { opacity: 0, textShadow: 'none' });

      // Reset script demo elements
      gsap.set(this.q('[data-line="8"]'), { opacity: 0 });
      gsap.set(this.q('[data-text="script-intro"]'), { opacity: 0 });
      gsap.set(this.qAll('.demo-command'), { opacity: 0 });
      gsap.set(this.qAll('.demo-output'), { opacity: 0 });
      this.qAll('[data-demo-typed]').forEach(el => { (el as HTMLElement).textContent = ''; });

      const cursor = this.q('.cursor');
      cursor?.classList.remove('active');
      
      const typed = this.q('.typed-text');
      if (typed) typed.textContent = '';
    }

    reset() {
      if (this.currentTimeline) {
        this.currentTimeline.kill();
        this.currentTimeline = null;
      }
      this.isPlaying = false;
      this.resetElements();
    }
  }

  function init() {
    const container = document.querySelector('[data-intro-animation]') as HTMLElement;
    if (container && !(container as any).__controller) {
      (container as any).__controller = new IntroAnimationController(container);
    }
  }

  init();
  document.addEventListener('DOMContentLoaded', init);
</script>
