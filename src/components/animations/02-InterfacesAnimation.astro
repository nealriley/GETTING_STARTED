---
/**
 * InterfacesAnimation.astro
 * 
 * Section 2: "Same Models, Different Interfaces"
 * 
 * Subtractive scene flow:
 * 1. Chat interface - isolated, can't access files
 * 2. Terminal - connected, reads files directly
 * 3. Insight - "Same intelligence. Different access."
 * 
 * Key visual: Same prompt, different outcomes based on local access.
 */

interface Props {
  class?: string;
}

const { class: className = '' } = Astro.props;
---

<div class:list={['interfaces-animation', className]} data-interfaces-animation>
  
  <!-- Scene 1: Chat Interface (Sandboxed) -->
  <div class="scene scene-chat" data-scene="chat">
    <div class="scene-label">Chat Interface</div>
    
    <div class="chat-container">
      <div class="chat-window">
        <div class="chat-header">
          <div class="chat-avatar">AI</div>
          <span class="chat-title">Assistant</span>
        </div>
        
        <div class="chat-messages">
          <div class="message user-message" data-chat="user">
            <span class="message-text">Summarize my project files</span>
          </div>
          
          <div class="message ai-message" data-chat="ai">
            <span class="message-text">I don't have access to your local files. Please paste the content you'd like me to summarize.</span>
          </div>
        </div>
      </div>
      
      <!-- Files below - unreachable -->
      <div class="files-barrier" data-chat="barrier">
        <div class="barrier-line"></div>
        <span class="barrier-label">Your Machine</span>
      </div>
      
      <div class="files-unreachable" data-chat="files">
        <div class="file-icon unreachable">
          <span class="icon">üìÑ</span>
          <span class="filename">report.md</span>
        </div>
        <div class="file-icon unreachable">
          <span class="icon">üìÅ</span>
          <span class="filename">data/</span>
        </div>
        <div class="file-icon unreachable">
          <span class="icon">üìÑ</span>
          <span class="filename">notes.txt</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Scene 2: Terminal (Connected) -->
  <div class="scene scene-terminal" data-scene="terminal">
    <div class="scene-label">Terminal</div>
    
    <div class="terminal-container">
      <!-- Files above - reachable -->
      <div class="files-reachable" data-term="files">
        <div class="file-icon reachable" data-file="1">
          <span class="icon">üìÑ</span>
          <span class="filename">report.md</span>
          <span class="connection-dot"></span>
        </div>
        <div class="file-icon reachable" data-file="2">
          <span class="icon">üìÅ</span>
          <span class="filename">data/</span>
          <span class="connection-dot"></span>
        </div>
        <div class="file-icon reachable" data-file="3">
          <span class="icon">üìÑ</span>
          <span class="filename">notes.txt</span>
          <span class="connection-dot"></span>
        </div>
      </div>
      
      <div class="connection-lines" data-term="lines">
        <svg class="lines-svg" viewBox="0 0 300 40" preserveAspectRatio="none">
          <path class="conn-line" d="M50,0 L150,40" data-line="1"/>
          <path class="conn-line" d="M150,0 L150,40" data-line="2"/>
          <path class="conn-line" d="M250,0 L150,40" data-line="3"/>
        </svg>
      </div>
      
      <div class="terminal-window" data-term="window">
        <div class="terminal-chrome">
          <div class="window-controls">
            <span class="dot red"></span>
            <span class="dot yellow"></span>
            <span class="dot green"></span>
          </div>
          <span class="terminal-title">Terminal</span>
        </div>
        
        <div class="terminal-content">
          <div class="term-line" data-term="prompt">
            <span class="prompt">$</span>
            <span class="typed-text"></span>
            <span class="cursor">‚ñà</span>
          </div>
          
          <div class="term-output" data-term="reading">
            <span class="status-icon">‚Üí</span> Reading project files...
          </div>
          
          <div class="term-output" data-term="found">
            <span class="status-icon">‚Üí</span> Found 8 files in ./project
          </div>
          
          <div class="term-output success" data-term="summary">
            <span class="status-icon">‚úì</span> Summary: 3 key themes identified across your documents.
          </div>
        </div>
      </div>
      
      <div class="machine-label" data-term="machine">
        <span>Your Machine</span>
      </div>
    </div>
  </div>

  <!-- Scene 3: Insight -->
  <div class="scene scene-insight" data-scene="insight">
    <div class="insight-content">
      <div class="insight-comparison">
        <div class="compare-item chat-compare" data-insight="chat">
          <div class="compare-icon">üí¨</div>
          <div class="compare-label">Chat</div>
          <div class="compare-desc">Isolated</div>
        </div>
        
        <div class="compare-vs" data-insight="vs">vs</div>
        
        <div class="compare-item terminal-compare" data-insight="terminal">
          <div class="compare-icon">‚å®Ô∏è</div>
          <div class="compare-label">Terminal</div>
          <div class="compare-desc">Connected</div>
        </div>
      </div>
      
      <div class="insight-text" data-insight="text">
        <div class="insight-main">Same intelligence. Different access.</div>
      </div>
    </div>
  </div>

</div>

<style>
  .interfaces-animation {
    height: 100%;
    width: 100%;
    position: relative;
    overflow: hidden;
    font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
  }

  /* Scenes */
  .scene {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 1.5rem;
    opacity: 0;
    visibility: hidden;
  }

  .scene-label {
    position: absolute;
    top: 1.5rem;
    left: 50%;
    transform: translateX(-50%);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: rgba(255, 255, 255, 0.4);
    opacity: 0;
  }

  /* ============================================
     SCENE 1: CHAT INTERFACE
     ============================================ */
  .chat-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.5rem;
    width: 100%;
    max-width: 360px;
  }

  .chat-window {
    width: 100%;
    background: #1a1a2e;
    border-radius: 16px;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  }

  .chat-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.875rem 1rem;
    background: rgba(255, 255, 255, 0.03);
    border-bottom: 1px solid rgba(255, 255, 255, 0.06);
  }

  .chat-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: 600;
    color: white;
  }

  .chat-title {
    font-size: 0.875rem;
    color: rgba(255, 255, 255, 0.8);
    font-family: system-ui, sans-serif;
  }

  .chat-messages {
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .message {
    max-width: 85%;
    padding: 0.625rem 0.875rem;
    border-radius: 12px;
    font-size: 0.8rem;
    line-height: 1.5;
    font-family: system-ui, sans-serif;
    opacity: 0;
  }

  .user-message {
    align-self: flex-end;
    background: #6366f1;
    color: white;
    border-bottom-right-radius: 4px;
  }

  .ai-message {
    align-self: flex-start;
    background: rgba(255, 255, 255, 0.08);
    color: rgba(255, 255, 255, 0.85);
    border-bottom-left-radius: 4px;
  }

  /* Barrier */
  .files-barrier {
    width: 100%;
    display: flex;
    align-items: center;
    gap: 1rem;
    opacity: 0;
  }

  .barrier-line {
    flex: 1;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(239, 68, 68, 0.5), transparent);
  }

  .barrier-label {
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: rgba(239, 68, 68, 0.7);
    white-space: nowrap;
  }

  /* Unreachable files */
  .files-unreachable {
    display: flex;
    gap: 1.25rem;
    opacity: 0;
  }

  .file-icon {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.375rem;
    padding: 0.5rem;
    position: relative;
  }

  .file-icon .icon {
    font-size: 1.5rem;
    filter: grayscale(0);
    transition: filter 0.3s;
  }

  .file-icon.unreachable .icon {
    filter: grayscale(1);
    opacity: 0.4;
  }

  .file-icon .filename {
    font-size: 0.65rem;
    color: rgba(255, 255, 255, 0.4);
  }

  .file-icon.unreachable .filename {
    color: rgba(255, 255, 255, 0.25);
  }

  /* ============================================
     SCENE 2: TERMINAL
     ============================================ */
  .terminal-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    max-width: 400px;
  }

  /* Reachable files */
  .files-reachable {
    display: flex;
    gap: 1.5rem;
    margin-bottom: 0;
    opacity: 0;
  }

  .file-icon.reachable .icon {
    filter: none;
    opacity: 1;
  }

  .file-icon.reachable .filename {
    color: rgba(255, 255, 255, 0.7);
  }

  .connection-dot {
    position: absolute;
    bottom: -4px;
    left: 50%;
    transform: translateX(-50%);
    width: 6px;
    height: 6px;
    background: #22c55e;
    border-radius: 50%;
    opacity: 0;
  }

  /* Connection lines */
  .connection-lines {
    width: 100%;
    height: 40px;
    opacity: 0;
  }

  .lines-svg {
    width: 100%;
    height: 100%;
  }

  .conn-line {
    stroke: #22c55e;
    stroke-width: 2;
    fill: none;
    opacity: 0.6;
    stroke-dasharray: 4 4;
  }

  /* Terminal window */
  .terminal-window {
    width: 100%;
    background: #0a0a0a;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid rgba(34, 197, 94, 0.3);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5), 0 0 20px rgba(34, 197, 94, 0.1);
    opacity: 0;
  }

  .terminal-chrome {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.625rem 0.875rem;
    background: #1a1a1a;
    border-bottom: 1px solid rgba(255, 255, 255, 0.06);
  }

  .window-controls {
    display: flex;
    gap: 6px;
  }

  .dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
  }

  .dot.red { background: #ff5f56; }
  .dot.yellow { background: #ffbd2e; }
  .dot.green { background: #27ca40; }

  .terminal-title {
    font-size: 0.7rem;
    color: rgba(255, 255, 255, 0.5);
  }

  .terminal-content {
    padding: 1rem 1.25rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    font-size: 0.8rem;
    line-height: 1.6;
  }

  .term-line {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    opacity: 0;
  }

  .prompt {
    color: #22c55e;
    font-weight: 600;
  }

  .typed-text {
    color: #e2e8f0;
  }

  .cursor {
    color: #22c55e;
    animation: blink 1s step-end infinite;
    visibility: hidden;
  }

  .cursor.active {
    visibility: visible;
  }

  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0; }
  }

  .term-output {
    padding-left: 1rem;
    color: rgba(255, 255, 255, 0.6);
    opacity: 0;
  }

  .term-output .status-icon {
    color: #60a5fa;
    margin-right: 0.25rem;
  }

  .term-output.success {
    color: #22c55e;
  }

  .term-output.success .status-icon {
    color: #22c55e;
  }

  /* Machine label */
  .machine-label {
    margin-top: 1rem;
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: rgba(34, 197, 94, 0.6);
    opacity: 0;
  }

  /* ============================================
     SCENE 3: INSIGHT
     ============================================ */
  .insight-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2rem;
  }

  .insight-comparison {
    display: flex;
    align-items: center;
    gap: 2rem;
  }

  .compare-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    opacity: 0;
  }

  .compare-icon {
    font-size: 2rem;
    line-height: 1;
  }

  .compare-label {
    font-size: 0.9rem;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.9);
    font-family: system-ui, sans-serif;
  }

  .compare-desc {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  .chat-compare .compare-desc {
    color: rgba(239, 68, 68, 0.8);
  }

  .terminal-compare .compare-desc {
    color: rgba(34, 197, 94, 0.8);
  }

  .compare-vs {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.3);
    font-style: italic;
    opacity: 0;
  }

  .insight-text {
    text-align: center;
    opacity: 0;
  }

  .insight-main {
    font-size: 1.1rem;
    color: rgba(255, 255, 255, 0.95);
    font-family: 'Lora', Georgia, serif;
    font-weight: 500;
  }

  /* Responsive */
  @media (max-width: 480px) {
    .chat-container,
    .terminal-container {
      max-width: 100%;
    }

    .message {
      font-size: 0.75rem;
    }

    .terminal-content {
      font-size: 0.75rem;
      padding: 0.875rem 1rem;
    }

    .insight-comparison {
      gap: 1.5rem;
    }

    .compare-icon {
      font-size: 1.5rem;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .cursor {
      animation: none;
      opacity: 1;
    }
  }
</style>

<script>
  import gsap from 'gsap';

  class InterfacesAnimationController {
    private container: HTMLElement;
    private timeline: gsap.core.Timeline | null = null;
    private isPlaying = false;

    constructor(container: HTMLElement) {
      this.container = container;
      this.init();
    }

    private init() {
      document.addEventListener('section:change', (e: Event) => {
        const detail = (e as CustomEvent).detail;
        if (detail.sectionData?.id === 'interfaces') {
          this.play();
        } else {
          this.reset();
        }
      });

      const hash = window.location.hash.slice(1);
      if (hash === 'interfaces') {
        setTimeout(() => this.play(), 500);
      }
    }

    private typeText(element: HTMLElement, text: string, duration: number): gsap.core.Tween {
      const chars = text.split('');
      element.textContent = '';
      
      return gsap.to({ charIndex: 0 }, {
        charIndex: chars.length,
        duration: duration,
        ease: 'none',
        onUpdate: function() {
          const index = Math.floor(this.targets()[0].charIndex);
          element.textContent = chars.slice(0, index).join('');
        }
      });
    }

    play() {
      if (this.isPlaying) return;

      if (this.timeline) {
        this.timeline.kill();
        this.timeline = null;
      }

      this.resetElements();
      this.isPlaying = true;

      this.timeline = gsap.timeline({
        onComplete: () => { this.isPlaying = false; }
      });

      const tl = this.timeline;
      const q = (sel: string) => this.container.querySelector(sel) as HTMLElement;
      const qAll = (sel: string) => this.container.querySelectorAll(sel);

      // ========================================
      // SCENE 1: CHAT INTERFACE
      // ========================================
      
      // Show chat scene
      tl.set(q('[data-scene="chat"]'), { visibility: 'visible' });
      tl.to(q('[data-scene="chat"]'), { opacity: 1, duration: 0.4 });
      tl.to(q('[data-scene="chat"] .scene-label'), { opacity: 1, duration: 0.3 }, '-=0.2');

      // User message appears
      tl.to(q('[data-chat="user"]'), { 
        opacity: 1, 
        duration: 0.4,
        ease: 'power2.out'
      }, '+=0.3');

      // Pause - reading user message
      tl.to({}, { duration: 1.0 });

      // AI response appears
      tl.to(q('[data-chat="ai"]'), { 
        opacity: 1, 
        duration: 0.5,
        ease: 'power2.out'
      });

      // Pause - let the limitation sink in
      tl.to({}, { duration: 1.5 });

      // Show barrier and unreachable files
      tl.to(q('[data-chat="barrier"]'), { opacity: 1, duration: 0.4 });
      tl.to(q('[data-chat="files"]'), { opacity: 1, duration: 0.4 }, '-=0.2');

      // Pause - show the separation
      tl.to({}, { duration: 2.0 });

      // ========================================
      // TRANSITION: Chat fades out
      // ========================================
      tl.to(q('[data-scene="chat"]'), { 
        opacity: 0, 
        duration: 0.5,
        ease: 'power2.in'
      });
      tl.set(q('[data-scene="chat"]'), { visibility: 'hidden' });

      // ========================================
      // SCENE 2: TERMINAL
      // ========================================
      
      // Show terminal scene
      tl.set(q('[data-scene="terminal"]'), { visibility: 'visible' });
      tl.to(q('[data-scene="terminal"]'), { opacity: 1, duration: 0.4 });
      tl.to(q('[data-scene="terminal"] .scene-label'), { opacity: 1, duration: 0.3 }, '-=0.2');

      // Show terminal window first
      tl.to(q('[data-term="window"]'), { 
        opacity: 1, 
        duration: 0.5,
        ease: 'power2.out'
      });

      // Show prompt line and cursor
      tl.to(q('[data-term="prompt"]'), { opacity: 1, duration: 0.2 });
      tl.call(() => {
        const cursor = q('[data-term="prompt"] .cursor');
        if (cursor) cursor.classList.add('active');
      });

      // Type the command
      tl.to({}, { duration: 0.3 }); // Brief pause before typing
      tl.add(this.typeText(
        q('[data-term="prompt"] .typed-text'), 
        'llm "Summarize my project files"', 
        1.5
      ));

      // Hide cursor after typing
      tl.call(() => {
        const cursor = q('[data-term="prompt"] .cursor');
        if (cursor) cursor.classList.remove('active');
      });

      // Show files appearing above
      tl.to(q('[data-term="files"]'), { opacity: 1, duration: 0.4 }, '-=0.3');
      
      // Show connection dots on files
      tl.to(qAll('.connection-dot'), { 
        opacity: 1, 
        duration: 0.3,
        stagger: 0.1
      });

      // Show connection lines
      tl.to(q('[data-term="lines"]'), { opacity: 1, duration: 0.3 });

      // Show machine label
      tl.to(q('[data-term="machine"]'), { opacity: 1, duration: 0.3 }, '-=0.2');

      // Terminal output - reading
      tl.to(q('[data-term="reading"]'), { opacity: 1, duration: 0.3 }, '+=0.2');
      tl.to({}, { duration: 0.5 });

      // Terminal output - found files
      tl.to(q('[data-term="found"]'), { opacity: 1, duration: 0.3 });
      tl.to({}, { duration: 0.5 });

      // Terminal output - summary (success)
      tl.to(q('[data-term="summary"]'), { opacity: 1, duration: 0.4 });

      // Pause - let the success sink in
      tl.to({}, { duration: 2.5 });

      // ========================================
      // TRANSITION: Terminal fades out
      // ========================================
      tl.to(q('[data-scene="terminal"]'), { 
        opacity: 0, 
        duration: 0.5,
        ease: 'power2.in'
      });
      tl.set(q('[data-scene="terminal"]'), { visibility: 'hidden' });

      // ========================================
      // SCENE 3: INSIGHT
      // ========================================
      
      // Show insight scene
      tl.set(q('[data-scene="insight"]'), { visibility: 'visible' });
      tl.to(q('[data-scene="insight"]'), { opacity: 1, duration: 0.4 });

      // Show comparison items
      tl.to(q('[data-insight="chat"]'), { 
        opacity: 1, 
        duration: 0.4,
        ease: 'power2.out'
      });
      
      tl.to(q('[data-insight="vs"]'), { 
        opacity: 1, 
        duration: 0.3 
      }, '-=0.2');
      
      tl.to(q('[data-insight="terminal"]'), { 
        opacity: 1, 
        duration: 0.4,
        ease: 'power2.out'
      }, '-=0.2');

      // Show insight text
      tl.to(q('[data-insight="text"]'), { 
        opacity: 1, 
        duration: 0.6,
        ease: 'power2.out'
      }, '+=0.3');

      // Hold at end
      tl.to({}, { duration: 2.0 });
    }

    private resetElements() {
      const q = (sel: string) => this.container.querySelector(sel) as HTMLElement;
      const qAll = (sel: string) => this.container.querySelectorAll(sel);

      // Hide all scenes
      gsap.set(qAll('.scene'), { opacity: 0, visibility: 'hidden' });
      gsap.set(qAll('.scene-label'), { opacity: 0 });

      // Reset chat scene elements
      gsap.set(qAll('[data-chat]'), { opacity: 0 });
      gsap.set(qAll('.message'), { opacity: 0 });

      // Reset terminal scene elements
      gsap.set(q('[data-term="window"]'), { opacity: 0 });
      gsap.set(q('[data-term="prompt"]'), { opacity: 0 });
      gsap.set(q('[data-term="files"]'), { opacity: 0 });
      gsap.set(q('[data-term="lines"]'), { opacity: 0 });
      gsap.set(q('[data-term="machine"]'), { opacity: 0 });
      gsap.set(qAll('.connection-dot'), { opacity: 0 });
      gsap.set(qAll('.term-output'), { opacity: 0 });
      
      // Clear typed text and hide cursor
      const typedText = q('[data-term="prompt"] .typed-text');
      if (typedText) typedText.textContent = '';
      const cursor = q('[data-term="prompt"] .cursor');
      if (cursor) cursor.classList.remove('active');

      // Reset insight scene elements
      gsap.set(qAll('[data-insight]'), { opacity: 0 });
    }

    reset() {
      if (this.timeline) {
        this.timeline.kill();
        this.timeline = null;
      }
      this.isPlaying = false;
      this.resetElements();
    }
  }

  function initAnimation() {
    const container = document.querySelector('[data-interfaces-animation]') as HTMLElement;
    if (container && !(container as any).__animationController) {
      (container as any).__animationController = new InterfacesAnimationController(container);
    }
  }

  initAnimation();
  document.addEventListener('DOMContentLoaded', initAnimation);
</script>
