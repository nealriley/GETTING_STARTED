---
/**
 * InterfacesAnimation.astro
 * 
 * Section 2: "Same Models, Different Interfaces"
 * 
 * Subtractive scene flow:
 * 1. Web browser (ChatGPT-style) - familiar chat interface
 * 2. Prompt "travels" to terminal
 * 3. Terminal - same prompt, but references local files
 * 4. Insight - "Same intelligence. Different access."
 * 
 * Key visual: The prompt moves between windows, showing same model, different capabilities.
 */

interface Props {
  class?: string;
}

const { class: className = '' } = Astro.props;
---

<div class:list={['interfaces-animation', className]} data-interfaces-animation>
  
  <!-- Scene 1: Web Browser (ChatGPT-style) -->
  <div class="scene scene-web" data-scene="web">
    <div class="scene-label">Web</div>
    
    <div class="browser-window">
      <!-- Browser Chrome -->
      <div class="browser-chrome">
        <div class="browser-controls">
          <span class="dot red"></span>
          <span class="dot yellow"></span>
          <span class="dot green"></span>
        </div>
        <div class="browser-nav">
          <button class="nav-btn">‚Üê</button>
          <button class="nav-btn">‚Üí</button>
          <button class="nav-btn">‚Üª</button>
          <button class="nav-btn">‚åÇ</button>
        </div>
        <div class="url-bar">
          <span class="url-icon">üîí</span>
          <span class="url-text">chat.openai.com</span>
        </div>
      </div>
      
      <!-- Chat App Layout -->
      <div class="chat-app">
        <!-- Sidebar -->
        <div class="chat-sidebar">
          <div class="sidebar-header">
            <span class="new-chat-btn">+ New chat</span>
          </div>
          <div class="sidebar-section">
            <span class="sidebar-label">Today</span>
            <div class="chat-history-item active">Draft email</div>
            <div class="chat-history-item">Meeting prep</div>
            <div class="chat-history-item">Research notes</div>
          </div>
        </div>
        
        <!-- Main Chat Area -->
        <div class="chat-main">
          <div class="chat-messages">
            <div class="message user-message" data-web="user">
              <div class="message-bubble">
                <span class="message-text">Help me draft an email about the project delay</span>
              </div>
            </div>
            
            <div class="message ai-message" data-web="ai">
              <div class="ai-avatar">‚ú¶</div>
              <div class="message-bubble">
                <div class="message-text">
                  <p>I'd be happy to help! To write an effective email, I'll need some details:</p>
                  <p>‚Ä¢ What caused the delay?</p>
                  <p>‚Ä¢ How long is the delay?</p>
                  <p>‚Ä¢ Who is the audience?</p>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Input Area -->
          <div class="chat-input-area" data-web="input">
            <div class="chat-input-box">
              <input type="text" placeholder="Message ChatGPT..." disabled />
              <button class="send-btn">‚Üë</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating Prompt (for transition) -->
  <div class="floating-prompt" data-element="floating-prompt">
    <span class="floating-text">Help me draft an email about the project delay</span>
  </div>

  <!-- Scene 2: Terminal -->
  <div class="scene scene-terminal" data-scene="terminal">
    <div class="scene-label">Terminal</div>
    
    <div class="terminal-window">
      <div class="terminal-chrome">
        <div class="window-controls">
          <span class="dot red"></span>
          <span class="dot yellow"></span>
          <span class="dot green"></span>
        </div>
        <span class="terminal-title">Terminal</span>
      </div>
      
      <div class="terminal-content">
        <div class="term-line prompt-line" data-term="prompt">
          <span class="prompt">&gt;</span>
          <span class="prompt-text">Help me draft an email about the project delay</span>
        </div>
        
        <div class="term-line thinking-line" data-term="thinking">
          <span class="thinking-indicator">
            <span class="thinking-dot"></span>
            <span class="thinking-dot"></span>
            <span class="thinking-dot"></span>
          </span>
          <span class="thinking-text">Thinking...</span>
        </div>
        
        <div class="term-response" data-term="response">
          <p class="context-note">Based on <span class="file-ref">~/projects/atlas/status.md</span>:</p>
          <p>Here's a draft email for the Atlas project delay:</p>
          <p><em>"Hi team, the vendor integration is taking longer than expected. We're now targeting March 15th instead of March 1st. I've updated the timeline doc with details."</em></p>
          <p class="file-saved"><span class="save-icon">‚úì</span> Saved to <span class="file-ref">~/Desktop/delay-email.txt</span></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Scene 3: Insight -->
  <div class="scene scene-insight" data-scene="insight">
    <div class="insight-content">
      <div class="insight-main">Same model, different interface.</div>
    </div>
  </div>

</div>

<style>
  .interfaces-animation {
    height: 100%;
    width: 100%;
    position: relative;
    overflow: hidden;
    font-family: system-ui, -apple-system, sans-serif;
  }

  /* Scenes */
  .scene {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 1.5rem;
    opacity: 0;
    visibility: hidden;
  }

  .scene-label {
    position: absolute;
    top: 1rem;
    left: 50%;
    transform: translateX(-50%);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: rgba(255, 255, 255, 0.4);
    font-family: 'SF Mono', 'Fira Code', monospace;
    opacity: 0;
  }

  /* ============================================
     BROWSER WINDOW
     ============================================ */
  .browser-window {
    width: 100%;
    max-width: 700px;
    height: 92%;
    display: flex;
    flex-direction: column;
    background: #1a1a1a;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    opacity: 0;
    transform: translateY(10px);
  }

  .browser-chrome {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.6rem 0.875rem;
    background: #2d2d2d;
    border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    flex-shrink: 0;
  }

  .browser-controls {
    display: flex;
    gap: 6px;
  }

  .dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
  }

  .dot.red { background: #ff5f56; }
  .dot.yellow { background: #ffbd2e; }
  .dot.green { background: #27ca40; }

  .browser-nav {
    display: flex;
    gap: 2px;
  }

  .nav-btn {
    width: 28px;
    height: 28px;
    background: transparent;
    border: none;
    color: rgba(255, 255, 255, 0.4);
    font-size: 0.9rem;
    border-radius: 4px;
    cursor: default;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .url-bar {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: rgba(255, 255, 255, 0.08);
    padding: 0.4rem 0.75rem;
    border-radius: 6px;
    max-width: 280px;
  }

  .url-icon {
    font-size: 0.75rem;
  }

  .url-text {
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.85rem;
    font-family: system-ui, sans-serif;
  }

  /* Chat App Layout */
  .chat-app {
    flex: 1;
    display: flex;
    min-height: 0;
    background: #0f0f0f;
  }

  /* Sidebar */
  .chat-sidebar {
    width: 160px;
    background: #171717;
    border-right: 1px solid rgba(255, 255, 255, 0.06);
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
  }

  .sidebar-header {
    padding: 0.875rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.06);
  }

  .new-chat-btn {
    display: block;
    padding: 0.5rem 0.75rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 6px;
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.8rem;
    text-align: center;
  }

  .sidebar-section {
    padding: 0.875rem 0.625rem;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .sidebar-label {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: rgba(255, 255, 255, 0.4);
    padding: 0.25rem 0.5rem;
    margin-bottom: 0.25rem;
  }

  .chat-history-item {
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.6);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .chat-history-item.active {
    background: rgba(255, 255, 255, 0.08);
    color: rgba(255, 255, 255, 0.9);
  }

  /* Main Chat */
  .chat-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
  }

  .chat-messages {
    flex: 1;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    overflow-y: auto;
  }

  .message {
    display: flex;
    gap: 0.75rem;
    opacity: 0;
  }

  .user-message {
    justify-content: flex-end;
  }

  .user-message .message-bubble {
    background: #2563eb;
    color: white;
    padding: 0.875rem 1.125rem;
    border-radius: 18px 18px 4px 18px;
    max-width: 85%;
  }

  .ai-message {
    align-items: flex-start;
  }

  .ai-avatar {
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, #10a37f, #1a7f64);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 0.9rem;
    flex-shrink: 0;
  }

  .ai-message .message-bubble {
    background: transparent;
    max-width: 90%;
  }

  .message-text {
    font-size: 1.1rem;
    line-height: 1.6;
    color: rgba(255, 255, 255, 0.9);
  }

  .message-text p {
    margin: 0 0 0.75rem 0;
  }

  .message-text p:last-child {
    margin-bottom: 0;
  }

  .message-text strong {
    color: white;
  }

  /* Chat Input */
  .chat-input-area {
    padding: 1rem 1.5rem;
    border-top: 1px solid rgba(255, 255, 255, 0.06);
    opacity: 0;
  }

  .chat-input-box {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 0.625rem 0.625rem 0.625rem 1rem;
  }

  .chat-input-box input {
    flex: 1;
    background: transparent;
    border: none;
    color: rgba(255, 255, 255, 0.5);
    font-size: 0.95rem;
    outline: none;
  }

  .send-btn {
    width: 36px;
    height: 36px;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    border-radius: 8px;
    color: rgba(255, 255, 255, 0.4);
    font-size: 1.1rem;
    cursor: default;
  }

  /* ============================================
     FLOATING PROMPT (Transition)
     ============================================ */
  .floating-prompt {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    padding: 1rem 1.5rem;
    background: #2563eb;
    border-radius: 18px;
    opacity: 0;
    visibility: hidden;
    z-index: 100;
    box-shadow: 0 8px 32px rgba(37, 99, 235, 0.4);
  }

  .floating-text {
    color: white;
    font-size: 1.1rem;
    white-space: nowrap;
  }

  /* ============================================
     TERMINAL WINDOW
     ============================================ */
  .terminal-window {
    width: 100%;
    max-width: 700px;
    height: 92%;
    display: flex;
    flex-direction: column;
    background: #0a0a0a;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    opacity: 0;
    transform: translateY(10px);
  }

  .terminal-chrome {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.6rem 0.875rem;
    background: #1a1a1a;
    border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    flex-shrink: 0;
  }

  .window-controls {
    display: flex;
    gap: 6px;
  }

  .terminal-title {
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.5);
    font-family: 'SF Mono', 'Fira Code', monospace;
  }

  .terminal-content {
    flex: 1;
    padding: 1.75rem 2rem;
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
    overflow-y: auto;
  }

  .term-line {
    opacity: 0;
  }

  .prompt-line {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
  }

  .prompt {
    color: #a78bfa;
    font-weight: 700;
    font-size: 1.25rem;
  }

  .prompt-text {
    color: rgba(255, 255, 255, 0.9);
    font-size: 1.15rem;
    font-family: system-ui, sans-serif;
  }

  /* Thinking indicator */
  .thinking-line {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding-left: 1.75rem;
  }

  .thinking-indicator {
    display: flex;
    gap: 4px;
  }

  .thinking-dot {
    width: 6px;
    height: 6px;
    background: #a78bfa;
    border-radius: 50%;
    animation: thinking-pulse 1.4s ease-in-out infinite;
  }

  .thinking-dot:nth-child(2) {
    animation-delay: 0.2s;
  }

  .thinking-dot:nth-child(3) {
    animation-delay: 0.4s;
  }

  @keyframes thinking-pulse {
    0%, 80%, 100% {
      opacity: 0.3;
      transform: scale(0.8);
    }
    40% {
      opacity: 1;
      transform: scale(1);
    }
  }

  .thinking-text {
    color: rgba(255, 255, 255, 0.5);
    font-size: 0.9rem;
    font-style: italic;
  }

  .term-response {
    padding-left: 1.75rem;
    border-left: 2px solid rgba(167, 139, 250, 0.3);
    opacity: 0;
  }

  .term-response p {
    margin: 0 0 0.875rem 0;
    font-size: 1.1rem;
    line-height: 1.6;
    color: rgba(255, 255, 255, 0.85);
    font-family: system-ui, sans-serif;
  }

  .term-response p:last-child {
    margin-bottom: 0;
  }

  .term-response strong {
    color: #22c55e;
  }

  .term-response .context-note {
    color: rgba(255, 255, 255, 0.6);
    font-style: italic;
    margin-bottom: 1.25rem;
  }

  .term-response .file-ref {
    color: #60a5fa;
    font-family: 'SF Mono', 'Fira Code', monospace;
    font-style: normal;
    font-size: 0.9em;
  }

  .term-response .file-saved {
    margin-top: 1.25rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    color: #22c55e;
    font-style: normal;
  }

  .term-response .save-icon {
    margin-right: 0.25rem;
  }

  /* ============================================
     INSIGHT
     ============================================ */
  .scene-insight {
    background: transparent;
  }

  .insight-content {
    text-align: center;
  }

  .insight-main {
    font-size: 1.75rem;
    color: rgba(255, 255, 255, 0.95);
    font-weight: 500;
    font-family: 'Lora', Georgia, serif;
    opacity: 0;
  }

  /* ============================================
     RESPONSIVE
     ============================================ */
  @media (max-width: 600px) {
    .browser-window,
    .terminal-window {
      max-width: 100%;
      height: 85%;
    }

    .chat-sidebar {
      width: 120px;
    }

    .url-bar {
      display: none;
    }

    .message-text,
    .term-response p {
      font-size: 0.95rem;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .floating-prompt {
      transition: none;
    }
  }
</style>

<script>
  import gsap from 'gsap';

  class InterfacesAnimationController {
    private container: HTMLElement;
    private timeline: gsap.core.Timeline | null = null;
    private isPlaying = false;

    constructor(container: HTMLElement) {
      this.container = container;
      this.init();
    }

    private init() {
      document.addEventListener('section:change', (e: Event) => {
        const detail = (e as CustomEvent).detail;
        if (detail.sectionData?.id === 'interfaces') {
          this.play();
        } else {
          this.reset();
        }
      });

      const hash = window.location.hash.slice(1);
      if (hash === 'interfaces') {
        setTimeout(() => this.play(), 500);
      }
    }

    play() {
      if (this.isPlaying) return;

      if (this.timeline) {
        this.timeline.kill();
        this.timeline = null;
      }

      this.resetElements();
      this.isPlaying = true;

      this.timeline = gsap.timeline({
        onComplete: () => { this.isPlaying = false; }
      });

      const tl = this.timeline;
      const q = (sel: string) => this.container.querySelector(sel) as HTMLElement;

      // ========================================
      // SCENE 1: WEB BROWSER
      // ========================================
      
      tl.set(q('[data-scene="web"]'), { visibility: 'visible' });
      tl.to(q('[data-scene="web"]'), { opacity: 1, duration: 0.3 });
      tl.to(q('[data-scene="web"] .scene-label'), { opacity: 1, duration: 0.3 }, '-=0.1');

      // Browser window appears
      tl.to(q('.browser-window'), {
        opacity: 1,
        y: 0,
        duration: 0.6,
        ease: 'power2.out'
      });

      tl.to({}, { duration: 0.5 });

      // User message
      tl.to(q('[data-web="user"]'), {
        opacity: 1,
        duration: 0.4,
        ease: 'power2.out'
      });

      tl.to({}, { duration: 1.2 });

      // AI response
      tl.to(q('[data-web="ai"]'), {
        opacity: 1,
        duration: 0.5,
        ease: 'power2.out'
      });

      // Input area
      tl.to(q('[data-web="input"]'), {
        opacity: 1,
        duration: 0.3
      }, '-=0.2');

      // Hold - let them read
      tl.to({}, { duration: 3.0 });

      // ========================================
      // TRANSITION: Prompt travels
      // ========================================

      // Get positions for the floating prompt animation
      const userBubble = q('[data-web="user"] .message-bubble');
      const floatingPrompt = q('[data-element="floating-prompt"]');
      
      // Position floating prompt over the user message
      tl.call(() => {
        const rect = userBubble.getBoundingClientRect();
        const containerRect = this.container.getBoundingClientRect();
        gsap.set(floatingPrompt, {
          top: rect.top - containerRect.top,
          left: rect.left - containerRect.left,
          transform: 'none',
          visibility: 'visible'
        });
      });

      // Fade out web scene except the user message briefly highlighted
      tl.to(q('.browser-window'), {
        opacity: 0.3,
        duration: 0.3
      });

      // Show floating prompt
      tl.to(floatingPrompt, {
        opacity: 1,
        duration: 0.2
      });

      // Fade out web completely
      tl.to(q('[data-scene="web"]'), {
        opacity: 0,
        duration: 0.3
      }, '+=0.2');

      // Move floating prompt to center, then down toward terminal position
      tl.to(floatingPrompt, {
        top: '50%',
        left: '50%',
        xPercent: -50,
        yPercent: -50,
        duration: 0.5,
        ease: 'power2.inOut'
      });

      tl.to({}, { duration: 0.3 });

      // Hide web scene, show terminal scene
      tl.set(q('[data-scene="web"]'), { visibility: 'hidden' });
      tl.set(q('[data-scene="terminal"]'), { visibility: 'visible' });
      tl.to(q('[data-scene="terminal"]'), { opacity: 1, duration: 0.3 });
      tl.to(q('[data-scene="terminal"] .scene-label'), { opacity: 1, duration: 0.3 }, '-=0.1');

      // Terminal window appears
      tl.to(q('.terminal-window'), {
        opacity: 1,
        y: 0,
        duration: 0.5,
        ease: 'power2.out'
      }, '-=0.2');

      // Move floating prompt toward the terminal prompt area and fade out
      tl.to(floatingPrompt, {
        top: '35%',
        opacity: 0,
        duration: 0.4,
        ease: 'power2.in'
      });

      // Show the prompt in terminal (it "landed")
      tl.to(q('[data-term="prompt"]'), {
        opacity: 1,
        duration: 0.3
      }, '-=0.2');

      tl.set(floatingPrompt, { visibility: 'hidden' });

      // ========================================
      // SCENE 2: TERMINAL
      // ========================================

      tl.to({}, { duration: 0.5 });

      // Show thinking indicator
      tl.to(q('[data-term="thinking"]'), {
        opacity: 1,
        duration: 0.3
      });

      // Hold on thinking
      tl.to({}, { duration: 1.5 });

      // Hide thinking, show response
      tl.to(q('[data-term="thinking"]'), {
        opacity: 0,
        duration: 0.2
      });

      // Response (includes context note about local files)
      tl.to(q('[data-term="response"]'), {
        opacity: 1,
        duration: 0.5,
        ease: 'power2.out'
      });

      // Hold
      tl.to({}, { duration: 3.0 });

      // ========================================
      // SCENE 3: INSIGHT
      // ========================================

      // Fade out terminal
      tl.to(q('[data-scene="terminal"]'), {
        opacity: 0,
        duration: 0.4
      });
      tl.set(q('[data-scene="terminal"]'), { visibility: 'hidden' });

      // Show insight
      tl.set(q('[data-scene="insight"]'), { visibility: 'visible' });
      tl.to(q('[data-scene="insight"]'), { opacity: 1, duration: 0.3 });

      tl.to(q('.insight-main'), {
        opacity: 1,
        duration: 0.6,
        ease: 'power2.out'
      });

      // Hold
      tl.to({}, { duration: 3.0 });
    }

    private resetElements() {
      const q = (sel: string) => this.container.querySelector(sel) as HTMLElement;
      const qAll = (sel: string) => this.container.querySelectorAll(sel);

      // Hide all scenes
      gsap.set(qAll('.scene'), { opacity: 0, visibility: 'hidden' });
      gsap.set(qAll('.scene-label'), { opacity: 0 });

      // Reset web scene
      gsap.set(q('.browser-window'), { opacity: 0, y: 10 });
      gsap.set(q('[data-web="user"]'), { opacity: 0 });
      gsap.set(q('[data-web="ai"]'), { opacity: 0 });
      gsap.set(q('[data-web="input"]'), { opacity: 0 });

      // Reset floating prompt
      gsap.set(q('[data-element="floating-prompt"]'), { 
        opacity: 0, 
        visibility: 'hidden',
        top: '50%',
        left: '50%',
        xPercent: -50,
        yPercent: -50
      });

      // Reset terminal scene
      gsap.set(q('.terminal-window'), { opacity: 0, y: 10 });
      gsap.set(q('[data-term="prompt"]'), { opacity: 0 });
      gsap.set(q('[data-term="thinking"]'), { opacity: 0 });
      gsap.set(q('[data-term="response"]'), { opacity: 0 });

      // Reset insight
      gsap.set(q('.insight-main'), { opacity: 0 });
    }

    reset() {
      if (this.timeline) {
        this.timeline.kill();
        this.timeline = null;
      }
      this.isPlaying = false;
      this.resetElements();
    }
  }

  function initAnimation() {
    const container = document.querySelector('[data-interfaces-animation]') as HTMLElement;
    if (container && !(container as any).__animationController) {
      (container as any).__animationController = new InterfacesAnimationController(container);
    }
  }

  initAnimation();
  document.addEventListener('DOMContentLoaded', initAnimation);
</script>
