---
/**
 * MarkdownAnimation.astro
 * 
 * Section 8: "The Unreasonable Usefulness of Markdown"
 * 
 * Shows how markdown files become "executable specifications":
 * - Chat is ephemeral, files are persistent
 * - Description becomes reality
 * - Markdown as lingua franca for AI collaboration
 * 
 * Key insight: You describe something in structured text, and it becomes real.
 */

interface Props {
  class?: string;
}

const { class: className = '' } = Astro.props;
---

<div class:list={['markdown-animation', className]} data-markdown-animation>
  <!-- Ephemeral vs Persistent -->
  <div class="comparison" data-element="comparison">
    <div class="compare-item ephemeral" data-compare="ephemeral">
      <div class="compare-header">
        <span class="icon">ðŸ’¬</span>
        <span class="label">Chat</span>
      </div>
      <div class="compare-body">
        <div class="message-fade" data-fade="1">Great idea! Let me...</div>
        <div class="message-fade" data-fade="2">Here's what I suggest...</div>
        <div class="message-fade" data-fade="3">Done! Anything else?</div>
      </div>
      <div class="compare-tag">Ephemeral</div>
    </div>

    <div class="vs-divider" data-element="vs">
      <span>vs</span>
    </div>

    <div class="compare-item persistent" data-compare="persistent">
      <div class="compare-header">
        <span class="icon">ðŸ“„</span>
        <span class="label">File</span>
      </div>
      <div class="compare-body">
        <div class="file-content">
          <span class="filename">AGENTS.md</span>
          <div class="file-preview">
            <span class="md-hash">#</span> Project Guidelines<br/>
            <span class="md-hash">##</span> How to respond...
          </div>
        </div>
      </div>
      <div class="compare-tag">Persistent</div>
    </div>
  </div>

  <!-- The Magic: Description â†’ Reality -->
  <div class="magic-section" data-element="magic">
    <div class="magic-header">
      <span class="magic-title">Description â†’ Reality</span>
    </div>
    
    <div class="magic-flow">
      <div class="flow-step" data-step="1">
        <span class="step-label">You write</span>
        <div class="step-content markdown">
          <code>## Task: Analyze CSV data</code>
          <code>- Read sales.csv</code>
          <code>- Generate monthly trends</code>
          <code>- Output chart as PNG</code>
        </div>
      </div>

      <div class="flow-arrow" data-arrow>â†’</div>

      <div class="flow-step" data-step="2">
        <span class="step-label">AI executes</span>
        <div class="step-content result">
          <div class="result-item">âœ“ CSV loaded (2,847 rows)</div>
          <div class="result-item">âœ“ Trends calculated</div>
          <div class="result-item">âœ“ chart.png created</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Why Markdown -->
  <div class="why-markdown" data-element="why">
    <div class="why-header">Why Markdown?</div>
    <div class="why-grid">
      <div class="why-item" data-why="1">
        <span class="why-icon">ðŸ‘¤</span>
        <span class="why-text">Human-readable</span>
      </div>
      <div class="why-item" data-why="2">
        <span class="why-icon">ðŸ¤–</span>
        <span class="why-text">AI-parseable</span>
      </div>
      <div class="why-item" data-why="3">
        <span class="why-icon">ðŸ”„</span>
        <span class="why-text">Everywhere</span>
      </div>
    </div>
  </div>

  <!-- Insight -->
  <div class="insight-box" data-element="insight">
    <span class="insight-text">Markdown is the lingua franca for AI collaboration.</span>
  </div>
</div>

<style>
  .markdown-animation {
    height: 100%;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
  }

  /* Comparison Section */
  .comparison {
    display: flex;
    align-items: stretch;
    gap: 0.5rem;
    opacity: 0;
  }

  .compare-item {
    flex: 1;
    display: flex;
    flex-direction: column;
    border-radius: 8px;
    overflow: hidden;
  }

  .compare-item.ephemeral {
    background: rgba(239, 68, 68, 0.08);
    border: 1px solid rgba(239, 68, 68, 0.2);
  }

  .compare-item.persistent {
    background: rgba(16, 185, 129, 0.08);
    border: 1px solid rgba(16, 185, 129, 0.2);
  }

  .compare-header {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.4rem 0.6rem;
    background: rgba(255, 255, 255, 0.03);
  }

  .compare-header .icon {
    font-size: 0.9rem;
  }

  .compare-header .label {
    font-weight: 600;
    color: rgba(255, 255, 255, 0.8);
  }

  .compare-body {
    flex: 1;
    padding: 0.5rem;
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
  }

  .message-fade {
    font-size: 0.65rem;
    color: rgba(255, 255, 255, 0.5);
    padding: 0.25rem 0.4rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 4px;
    opacity: 0;
  }

  .file-content {
    opacity: 0;
  }

  .filename {
    display: block;
    font-size: 0.65rem;
    color: #60a5fa;
    margin-bottom: 0.3rem;
  }

  .file-preview {
    font-size: 0.6rem;
    color: rgba(255, 255, 255, 0.6);
    line-height: 1.5;
  }

  .md-hash {
    color: #8b5cf6;
  }

  .compare-tag {
    text-align: center;
    font-size: 0.55rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    padding: 0.25rem;
    background: rgba(255, 255, 255, 0.03);
  }

  .ephemeral .compare-tag {
    color: rgba(239, 68, 68, 0.8);
  }

  .persistent .compare-tag {
    color: rgba(16, 185, 129, 0.8);
  }

  .vs-divider {
    display: flex;
    align-items: center;
    padding: 0 0.25rem;
    opacity: 0;
  }

  .vs-divider span {
    color: rgba(255, 255, 255, 0.3);
    font-size: 0.7rem;
  }

  /* Magic Section */
  .magic-section {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    padding: 0.75rem;
    background: rgba(139, 92, 246, 0.05);
    border: 1px solid rgba(139, 92, 246, 0.15);
    border-radius: 8px;
    opacity: 0;
  }

  .magic-header {
    text-align: center;
  }

  .magic-title {
    font-size: 0.8rem;
    color: rgba(139, 92, 246, 0.9);
    font-weight: 600;
  }

  .magic-flow {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .flow-step {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
    opacity: 0;
    transform: translateY(10px);
  }

  .step-label {
    font-size: 0.6rem;
    color: rgba(255, 255, 255, 0.5);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .step-content {
    padding: 0.5rem;
    border-radius: 6px;
    font-size: 0.65rem;
  }

  .step-content.markdown {
    background: rgba(0, 0, 0, 0.3);
    display: flex;
    flex-direction: column;
    gap: 0.2rem;
  }

  .step-content.markdown code {
    color: rgba(255, 255, 255, 0.8);
  }

  .step-content.result {
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid rgba(16, 185, 129, 0.2);
  }

  .result-item {
    color: #10b981;
    padding: 0.15rem 0;
  }

  .flow-arrow {
    color: rgba(139, 92, 246, 0.6);
    font-size: 1.2rem;
    opacity: 0;
  }

  /* Why Markdown */
  .why-markdown {
    opacity: 0;
  }

  .why-header {
    font-size: 0.7rem;
    color: rgba(255, 255, 255, 0.6);
    margin-bottom: 0.4rem;
    text-align: center;
  }

  .why-grid {
    display: flex;
    justify-content: center;
    gap: 1rem;
  }

  .why-item {
    display: flex;
    align-items: center;
    gap: 0.3rem;
    opacity: 0;
    transform: translateY(5px);
  }

  .why-icon {
    font-size: 0.9rem;
  }

  .why-text {
    font-size: 0.65rem;
    color: rgba(255, 255, 255, 0.7);
  }

  /* Insight */
  .insight-box {
    text-align: center;
    padding: 0.6rem 1rem;
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(59, 130, 246, 0.1));
    border: 1px solid rgba(139, 92, 246, 0.25);
    border-radius: 8px;
    opacity: 0;
    transform: translateY(10px);
  }

  .insight-text {
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.95);
    font-family: 'Lora', serif;
    font-weight: 500;
  }

  /* Responsive */
  @media (max-width: 1200px) {
    .magic-flow {
      flex-direction: column;
    }

    .flow-arrow {
      transform: rotate(90deg);
    }

    .why-grid {
      flex-wrap: wrap;
      gap: 0.5rem;
    }
  }
</style>

<script>
  import gsap from 'gsap';

  class MarkdownAnimationController {
    private container: HTMLElement;
    private timeline: gsap.core.Timeline | null = null;
    private isPlaying = false;

    constructor(container: HTMLElement) {
      this.container = container;
      this.init();
    }

    private init() {
      document.addEventListener('section:change', (e: Event) => {
        const detail = (e as CustomEvent).detail;
        if (detail.sectionData?.id === 'markdown') {
          this.play();
        } else {
          this.reset();
        }
      });

      const hash = window.location.hash.slice(1);
      if (hash === 'markdown') {
        setTimeout(() => this.play(), 500);
      }
    }

    play() {
      if (this.isPlaying) return;

      if (this.timeline) {
        this.timeline.kill();
        this.timeline = null;
      }

      this.resetElements();
      this.isPlaying = true;

      this.timeline = gsap.timeline({
        onComplete: () => { this.isPlaying = false; }
      });

      const tl = this.timeline;

      // Show comparison
      tl.to(this.container.querySelector('[data-element="comparison"]'), {
        opacity: 1,
        duration: 0.4
      });

      // Fade in chat messages (ephemeral)
      tl.to(this.container.querySelector('[data-fade="1"]'), { opacity: 0.8, duration: 0.2 }, '+=0.2');
      tl.to(this.container.querySelector('[data-fade="1"]'), { opacity: 0.3, duration: 0.3 }, '+=0.3');
      tl.to(this.container.querySelector('[data-fade="2"]'), { opacity: 0.8, duration: 0.2 }, '-=0.1');
      tl.to(this.container.querySelector('[data-fade="2"]'), { opacity: 0.3, duration: 0.3 }, '+=0.3');
      tl.to(this.container.querySelector('[data-fade="3"]'), { opacity: 0.8, duration: 0.2 }, '-=0.1');
      tl.to(this.container.querySelector('[data-fade="3"]'), { opacity: 0.2, duration: 0.4 }, '+=0.3');

      // Show vs
      tl.to(this.container.querySelector('[data-element="vs"]'), {
        opacity: 1,
        duration: 0.3
      }, '-=0.3');

      // Show file (persistent)
      tl.to(this.container.querySelector('.file-content'), {
        opacity: 1,
        duration: 0.4
      });

      tl.to({}, { duration: 0.8 });

      // Show magic section
      tl.to(this.container.querySelector('[data-element="magic"]'), {
        opacity: 1,
        duration: 0.4
      });

      // Show step 1 (markdown)
      tl.to(this.container.querySelector('[data-step="1"]'), {
        opacity: 1,
        y: 0,
        duration: 0.4,
        ease: 'power2.out'
      });

      tl.to({}, { duration: 0.8 });

      // Show arrow
      tl.to(this.container.querySelector('[data-arrow]'), {
        opacity: 1,
        duration: 0.3
      });

      // Show step 2 (result)
      tl.to(this.container.querySelector('[data-step="2"]'), {
        opacity: 1,
        y: 0,
        duration: 0.4,
        ease: 'power2.out'
      });

      tl.to({}, { duration: 0.8 });

      // Show why markdown
      tl.to(this.container.querySelector('[data-element="why"]'), {
        opacity: 1,
        duration: 0.3
      });

      // Show why items
      tl.to(this.container.querySelectorAll('.why-item'), {
        opacity: 1,
        y: 0,
        duration: 0.25,
        stagger: 0.1,
        ease: 'power2.out'
      });

      tl.to({}, { duration: 0.5 });

      // Show insight
      tl.to(this.container.querySelector('[data-element="insight"]'), {
        opacity: 1,
        y: 0,
        duration: 0.5,
        ease: 'power2.out'
      });
    }

    private resetElements() {
      gsap.set(this.container.querySelector('[data-element="comparison"]'), { opacity: 0 });
      gsap.set(this.container.querySelectorAll('.message-fade'), { opacity: 0 });
      gsap.set(this.container.querySelector('.file-content'), { opacity: 0 });
      gsap.set(this.container.querySelector('[data-element="vs"]'), { opacity: 0 });
      gsap.set(this.container.querySelector('[data-element="magic"]'), { opacity: 0 });
      gsap.set(this.container.querySelectorAll('.flow-step'), { opacity: 0, y: 10 });
      gsap.set(this.container.querySelector('[data-arrow]'), { opacity: 0 });
      gsap.set(this.container.querySelector('[data-element="why"]'), { opacity: 0 });
      gsap.set(this.container.querySelectorAll('.why-item'), { opacity: 0, y: 5 });
      gsap.set(this.container.querySelector('[data-element="insight"]'), { opacity: 0, y: 10 });
    }

    reset() {
      if (this.timeline) {
        this.timeline.kill();
        this.timeline = null;
      }
      this.isPlaying = false;
      this.resetElements();
    }
  }

  function initAnimation() {
    const container = document.querySelector('[data-markdown-animation]') as HTMLElement;
    if (container && !(container as any).__animationController) {
      (container as any).__animationController = new MarkdownAnimationController(container);
    }
  }

  initAnimation();
  document.addEventListener('DOMContentLoaded', initAnimation);
</script>
