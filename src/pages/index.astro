---
/**
 * index.astro
 * 
 * Main entry point for the Getting Started educational experience.
 * Full-screen immersive split-screen layout.
 * Does NOT use BaseLayout to avoid wrapper constraints.
 * 
 * Loads section content from Astro Content Collections.
 */

import SplitLayout from '../components/SplitLayout.astro';
import { getCollection } from 'astro:content';
import type { SectionData } from '../lib/sections';
import { getTimeline } from '../lib/timelines';

// Load sections from content collection
const sectionEntries = await getCollection('sections');

// Sort by number and transform to SectionData format
const SECTIONS: SectionData[] = sectionEntries
  .sort((a, b) => a.data.number - b.data.number)
  .map((entry) => {
    // Parse content into messages for chat-style display
    const messages = parseContentToMessages(entry.body);
    // Also keep full HTML for backward compatibility
    const html = renderContentToHTML(entry.body);
    
    return {
      id: entry.data.id,
      number: entry.data.number,
      title: entry.data.title,
      content: html,
      messages: messages,
      wordCount: entry.body.split(/\s+/).length,
      hasAnimation: true,
      animationComponent: entry.data.animation,
      timeline: getTimeline(entry.data.id),  // Add timeline if defined
    };
  });

/**
 * Convert a markdown block to HTML
 */
function markdownBlockToHTML(block: string): string {
  block = block.trim();
  if (!block) return '';
  
  // Convert inline markdown first
  let html = block
    // Convert bold
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    // Convert italic (but not inside URLs or already processed)
    .replace(/(?<!\*)\*([^*]+?)\*(?!\*)/g, '<em>$1</em>')
    // Convert inline code
    .replace(/`([^`]+)`/g, '<code>$1</code>');
  
  // Determine block type
  if (html.startsWith('## ')) {
    return `<h2>${html.slice(3)}</h2>`;
  }
  if (html.startsWith('### ')) {
    return `<h3>${html.slice(4)}</h3>`;
  }
  if (html.startsWith('> ')) {
    return `<blockquote>${html.slice(2)}</blockquote>`;
  }
  if (html.startsWith('- ') || /^\d+\. /.test(html)) {
    // List block - convert all list items
    const items = html.split('\n').map(line => {
      if (line.startsWith('- ')) {
        return `<li>${line.slice(2)}</li>`;
      }
      if (/^\d+\. /.test(line)) {
        return `<li>${line.replace(/^\d+\. /, '')}</li>`;
      }
      return line;
    }).join('');
    return `<ul>${items}</ul>`;
  }
  if (html.startsWith('```')) {
    // Code block
    const match = html.match(/```(\w*)\n([\s\S]*?)```/);
    if (match) {
      return `<pre><code>${match[2]}</code></pre>`;
    }
  }
  
  // Regular paragraph
  return `<p>${html}</p>`;
}

/**
 * Parse markdown content into an array of HTML message blocks.
 * Each paragraph/block becomes one "message" for chat-style display.
 */
function parseContentToMessages(markdown: string): string[] {
  // Split on double newlines (paragraph boundaries)
  const blocks = markdown.split(/\n\n+/);
  
  const messages: string[] = [];
  
  for (const block of blocks) {
    const trimmed = block.trim();
    if (!trimmed) continue;
    
    const html = markdownBlockToHTML(trimmed);
    if (html) {
      messages.push(html);
    }
  }
  
  return messages;
}

/**
 * Render markdown content to a single HTML string (for backward compatibility)
 */
function renderContentToHTML(markdown: string): string {
  const messages = parseContentToMessages(markdown);
  return messages.join('\n');
}

const title = "Getting Started â€” AI Tools for the Technical Adjacent";
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <meta name="description" content="A foundation for AI-assisted technical work" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Lora:ital,wght@0,400;0,500;0,600;1,400;1,500&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
  </head>
  <body>
    <SplitLayout sections={SECTIONS} initialSection={1} />
  </body>
</html>

<style is:global>
  /* Reset and base styles - Full-screen immersive experience */
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  
  html {
    font-size: 16px;
    scroll-behavior: smooth;
    height: 100%;
  }
  
  body {
    font-family: 'Lora', Georgia, 'Times New Roman', serif;
    background: #0a0a0f;
    color: #e5e7eb;
    line-height: 1.7;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    height: 100%;
    overflow: hidden;
  }
  
  /* CSS Custom Properties - Dark theme */
  :root {
    --text-primary: rgba(255, 255, 255, 0.95);
    --text-secondary: rgba(255, 255, 255, 0.7);
    --text-muted: rgba(255, 255, 255, 0.4);
    --border: rgba(255, 255, 255, 0.08);
    --bg-dark: #0a0a0f;
    --bg-panel: #0f0f14;
    --accent: #3b82f6;
    --accent-secondary: #8b5cf6;
    --accent-dark: #2563eb;
    --success: #10b981;
    --warning: #f59e0b;
    --error: #ef4444;
  }
  
  /* Focus styles for accessibility - dark theme */
  :focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }
  
  /* Selection - dark theme */
  ::selection {
    background: rgba(139, 92, 246, 0.3);
    color: #fff;
  }
  
  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }
</style>
